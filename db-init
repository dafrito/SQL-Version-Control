#!/bin/sh
# Initializes a directory to be used as a db-utils repository
PATH=/bin:/usr/bin:$HOME/bin:${0%/*}

DB_DONT_COMPLAIN=0 . db-load-settings.sh #2>/dev/null

CONFIG_ROOT="./.db"

if [ -z "$db" ]; then
    echo "db: Usage db-init [options] <database-name>" 1>&2
    exit 1
fi

if [ ! -e $CONFIG_ROOT ]; then
    if ! mkdir $CONFIG_ROOT; then
        exit 1
    fi
fi

if [ ! -e $CONFIG_ROOT/default ]; then
    echo $db >$CONFIG_ROOT/default
fi

SETTINGS="$CONFIG_ROOT/$db.settings"
if [ ! -e "$SETTINGS" ]; then
    if ! touch $SETTINGS; then
        echo "db-init: $SETTINGS is not accessible"
        exit 1;
    fi
    if [ -n "$LOG" ]; then
        echo "LOG=$LOG" >>$SETTINGS
    fi
fi;

if [ -n "$PASSWORD" ]; then
    echo $PASSWORD >$db.password
fi

if [ ! -e "$root" ]; then
    if ! mkdir $root; then
        exit 1;
    fi
fi

if ! touch $patchlist; then
    exit 1;
fi

if ! cp ${0%/*}/db-init.sql .db/$db-init.sql; then
    exit 1;
fi;

if ! cp ${0%/*}/db-ignore .db/$db-ignore; then
    exit 1;
fi;
